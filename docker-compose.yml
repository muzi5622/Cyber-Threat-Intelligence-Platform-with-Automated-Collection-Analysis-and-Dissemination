version: "3.9"

services:
  # =========================================================
  # LAYER 1 — Core dependencies required by OpenCTI
  # =========================================================

  redis:
    # Used by OpenCTI for caching + internal queues
    image: redis:7
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  elasticsearch:
    # Stores OpenCTI data (search + indexing)
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.ml.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes:
      - esdata:/usr/share/elasticsearch/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 30

  minio:
    # Object storage used by OpenCTI (imports/exports/attachments)
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    command: server /data
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASS}
    volumes:
      - miniodata:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/minio/health/live >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  rabbitmq:
    # Message broker used by OpenCTI + worker/connectors (job distribution)
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      # RabbitMQ UI (optional, helpful for debugging)
      - "15672:15672"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
      interval: 10s
      timeout: 5s
      retries: 20

  # =========================================================
  # LAYER 2 — OpenCTI platform + worker
  # =========================================================

  opencti:
    # Main OpenCTI web app + GraphQL API
    image: opencti/platform:latest
    environment:
      - APP__PORT=8080
      - APP__BASE_URL=${APP_BASE_URL}

      # Initial admin user (first start)
      - APP__ADMIN__EMAIL=${OPENCTI_ADMIN_EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_ADMIN_PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_ADMIN_TOKEN}

      - APP__LOGS_LEVEL=info

      # Dependencies
      - REDIS__HOSTNAME=redis
      - ELASTICSEARCH__URL=http://elasticsearch:9200

      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__ACCESS_KEY=${MINIO_USER}
      - MINIO__SECRET_KEY=${MINIO_PASS}

      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__USERNAME=${RABBITMQ_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_PASS}
    depends_on:
      - redis
      - elasticsearch
      - minio
      - rabbitmq
    ports:
      # OpenCTI UI + API
      - "8080:8080"
    restart: unless-stopped

    # Note: opencti image doesn't always include curl, so use python for healthcheck
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python3 - <<'PY'\nimport os, json, urllib.request\nurl='http://localhost:8080/graphql'\ntoken=os.environ.get('APP__ADMIN__TOKEN','')\npayload={'query':'query { about { version } }'}\nheaders={'Content-Type':'application/json','Authorization':f'Bearer {token}'}\nreq=urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers)\nurllib.request.urlopen(req, timeout=5).read()\nprint('ok')\nPY"
        ]
      interval: 15s
      timeout: 10s
      retries: 40

  worker:
    # Processes background tasks (imports/enrichments/rules jobs)
    image: opencti/worker:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - WORKER_LOG_LEVEL=info
    depends_on:
      - opencti
    restart: unless-stopped

  # =========================================================
  # LAYER 3 — Your automation services (CTI pipeline)
  # =========================================================

  rss-ingestor:
    # Collects threat intel articles from RSS feeds and creates OpenCTI Reports
    build: ./services/rss-ingestor
    environment:
      OPENCTI_BASE: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"

      # Runs every N seconds (5 min default)
      RUN_EVERY_SECONDS: "300"

      # Ingestion controls
      MAX_ITEMS_PER_FEED: "5"
      LOOKBACK_DAYS: "30"
      DISABLE_DEDUP: "false"

      # Local state (for dedup / last seen items)
      RSS_STATE_DB: "/state/rss.db"

      # Report metadata in OpenCTI
      RSS_PRODUCER_NAME: "RSS Feed Ingestor"
      RSS_PRODUCER_DESC: "Automated OSINT collection from CTI RSS sources."
      RSS_CONFIDENCE: "50"
      FEEDS_FILE: "/app/feeds.txt"
    volumes:
      - ./data/rss:/state
    depends_on:
      - opencti
    restart: unless-stopped

  connector-urlhaus:
    # Imports URLhaus data into OpenCTI once per day (low CPU)
    image: opencti/connector-urlhaus:rolling
    restart: unless-stopped
    depends_on:
      - opencti
      - rabbitmq

    # Low resource usage (works with docker compose)
    cpus: "0.10"
    mem_limit: 384m

    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}

      # Must be a UUID (unique per connector)
      - CONNECTOR_ID=${CONNECTOR_URLHAUS_ID}

      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=URLHaus
      - CONNECTOR_SCOPE=urlhaus
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_CONFIDENCE_LEVEL=75

      # Run on a schedule (P1D = once per day)
      - CONNECTOR_RUN_AND_TERMINATE=false
      - CONNECTOR_DURATION_PERIOD=P1D


  nlp-enricher:
    # Reads new Reports, extracts IOCs (IPs/domains/URLs/hashes),
    # and creates Observables/Indicators in OpenCTI.
    build: ./services/nlp-enricher
    environment:
      OPENCTI_BASE: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"

      # Runs every N seconds (2 min default)
      RUN_EVERY_SECONDS: "120"

      # Create Indicator objects in addition to Observables
      NLP_CREATE_INDICATOR: "true"

      # Label applied to extracted entities
      NLP_LABEL: "auto-extracted"

      # Local state DB (what reports were already processed)
      NLP_STATE_DB: "/state/nlp.db"

      # Only analyze reports newer than N days
      NLP_MAX_AGE_DAYS: "14"

      # Max reports to fetch per run
      NLP_FETCH_LIMIT: "20"
    volumes:
      - ./data/nlp:/state
    depends_on:
      - opencti
    restart: unless-stopped

  ml-ner-enricher:
    build: ./services/ml-ner-enricher
    restart: unless-stopped
    depends_on:
      - opencti
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - MODEL_PATH=/app/models/cti_ner_model_n
      - NER_THRESHOLD=0.55
      - POLL_SECONDS=60
      - LOOKBACK_HOURS=24
      - BATCH_SIZE=50
      - CREATE_OBSERVABLES=true
      - CREATE_ENTITIES=false
      - STATE_PATH=/data/state.json
    volumes:
      - ./data/ml:/data


    

  intel-api:
    # Optional API you built (example: serve latest IOCs/reports to other tools)
    build: ./services/intel-api
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - STRATEGY_ENABLED=true
      - STRATEGY_TIMEZONE=Asia/Karachi
      # Daily at 09:00
      - STRATEGY_DAILY_CRON=0 9 * * *
      # Weekly Monday at 09:00
      - STRATEGY_WEEKLY_CRON=0 9 * * 1
      # Minimum score to auto-create action cases
      - STRATEGY_CASE_THRESHOLD=70
    ports:
      - "8000:8000"
    depends_on:
      - opencti
    restart: unless-stopped

  # =========================================================
  # LAYER 4 — Dissemination (OpenCTI → STIX bundles on disk → served via TAXII)
  # =========================================================

  taxii-exporter:
    # Exports STIX bundles from OpenCTI and writes to /exports
    build: ./services/taxii-exporter
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - EXPORT_DIR=/exports
      - RUN_EVERY_SECONDS=300
    volumes:
      - ./data/opencti-export:/exports
    depends_on:
      - opencti
    restart: unless-stopped

  taxii-server:
    # Serves exported bundles over TAXII (Medallion TAXII server)
    image: cti-taxii-server:latest
    build:
      context: ./services/taxii-exporter/medallion
    environment:
      - TAXII_HOST=0.0.0.0
      - TAXII_PORT=9000
    ports:
      - "9000:9000"
    volumes:
      - ./data/opencti-export:/data
    restart: unless-stopped

# =========================================================
# Named volumes (persistent data for core services)
# =========================================================
volumes:
  esdata:
  miniodata:
 
