services:
  # -------------------------
  # Layer 3: Core dependencies
  # -------------------------
  redis:
    image: redis:7
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.ml.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes:
      - esdata:/usr/share/elasticsearch/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 30

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    command: server /data
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASS}
    volumes:
      - miniodata:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/minio/health/live >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      - "15672:15672"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
      interval: 10s
      timeout: 5s
      retries: 20

  # -------------------------
  # Layer 3: OpenCTI platform
  # -------------------------
  opencti:
    image: opencti/platform:latest
    environment:
      - APP__PORT=8080
      - APP__BASE_URL=${APP_BASE_URL}

      - APP__ADMIN__EMAIL=${OPENCTI_ADMIN_EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_ADMIN_PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_ADMIN_TOKEN}

      - APP__LOGS_LEVEL=info

      - REDIS__HOSTNAME=redis
      - ELASTICSEARCH__URL=http://elasticsearch:9200

      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__ACCESS_KEY=${MINIO_USER}
      - MINIO__SECRET_KEY=${MINIO_PASS}

      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__USERNAME=${RABBITMQ_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_PASS}
    depends_on:
      - redis
      - elasticsearch
      - minio
      - rabbitmq
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/graphql >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 40

  worker:
    image: opencti/worker:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - WORKER_LOG_LEVEL=info
    depends_on:
      - opencti
    restart: unless-stopped

  # -------------------------
  # Layer 1: OSINT (SpiderFoot)
  # -------------------------
  spiderfoot:
    image: dtagdevsec/spiderfoot:24.04
    command: ["python3", "/home/spiderfoot/sf.py", "-l", "0.0.0.0:8080"]
    ports:
      - "5001:8080"
    restart: unless-stopped

    # -------------------------
  # Layer 1: RSS Feed Collection (Automated)
  # -------------------------
  rss-ingestor:
    build: ./services/rss-ingestor
    environment:
      OPENCTI_BASE: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      RUN_EVERY_SECONDS: "300"

      # Make lots of reports for demo
      MAX_ITEMS_PER_FEED: "5"
      LOOKBACK_DAYS: "30"
      DISABLE_DEDUP: "false"

      RSS_STATE_DB: "/state/rss.db"
      RSS_PRODUCER_NAME: "RSS Feed Ingestor"
      RSS_PRODUCER_DESC: "Automated OSINT collection from CTI RSS sources."
      RSS_CONFIDENCE: "50"
      FEEDS_FILE: "/app/feeds.txt"
    volumes:
      - ./data/rss:/state
    depends_on:
      - opencti
    restart: unless-stopped


  # -------------------------
  # Layer 1: SpiderFoot clean entry URL (optional)
  # -------------------------
  spiderfoot-web:
    image: nginx:alpine
    ports:
      - "5002:80"
    depends_on:
      - spiderfoot
    volumes:
      - ./services/spiderfoot-web/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  # -------------------------
  # Layer 4: NLP/ML Enricher (custom)
  # -------------------------
  nlp-enricher:
    build: ./services/nlp-enricher
    environment:
      OPENCTI_BASE: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      RUN_EVERY_SECONDS: "120"
      NLP_CREATE_INDICATOR: "true"
      NLP_LABEL: "auto-extracted"
      NLP_STATE_DB: "/state/nlp.db"
      NLP_MAX_AGE_DAYS: "14"
      NLP_FETCH_LIMIT: "20"
      MAX_ITEMS_PER_FEED: "10"
      LOOKBACK_DAYS: "60"
      DISABLE_DEDUP: "true"

    volumes:
      - ./data/nlp:/state
    depends_on:
      - opencti
    restart: unless-stopped
  # -------------------------
  # Layer 4: SpiderFoot automation (OpenCTI -> SpiderFoot -> OpenCTI)
  # -------------------------
  spiderfoot-automation:
    build: ./services/spiderfoot-automation
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - RUN_EVERY_SECONDS=600
      - REPORT_LIMIT=30
      - SF_TIMEOUT_SECONDS=300
      - SF_USECASE=passive
      - SF_MAX_THREADS=10
      - SF_MAX_TARGETS_PER_CYCLE=10
      - STATE_PATH=/data/state.json
      - OUT_DIR=/data/scans
      - SF_MODULES=sfp_dnsresolve,sfp_sslcert,sfp_whois,sfp_hosting,sfp_webserver
    volumes:
      - ./data/spiderfoot-automation:/data
    depends_on:
      - opencti
      - spiderfoot
    restart: unless-stopped
  # -------------------------
  # Layer 5: Intelligence API (custom)
  # -------------------------
  intel-api:
    build: ./services/intel-api
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
    ports:
      - "8000:8000"
    depends_on:
      - opencti
    restart: unless-stopped

  # -------------------------
  # Layer 5: Exporter + "TAXII demo server"
  # -------------------------
  taxii-exporter:
    build: ./services/taxii-exporter
    environment:
      - OPENCTI_BASE=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - EXPORT_DIR=/exports
      - RUN_EVERY_SECONDS=300
    volumes:
      - ./data/opencti-export:/exports
    depends_on:
      - opencti
    restart: unless-stopped

  taxii-server:
    image: cti-taxii-server:latest
    build:
      context: ./services/taxii-exporter/medallion
    environment:
      - TAXII_HOST=0.0.0.0
      - TAXII_PORT=9000
    ports:
      - "9000:9000"
    volumes:
      - ./data/opencti-export:/data
    restart: unless-stopped

volumes:
  esdata:
  miniodata:
 
